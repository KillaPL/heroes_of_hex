<button id='get_session'>Get session</button>
<br>
<div>
  Your session key is: <span id='session_key'></span>
</div>

<script>
  var getSessionButton = document.querySelector("#get_session");
  var sessionKey       = document.querySelector("#session_key");
  var getSessionUrl    = "http://localhost:3000/sessions";

  getSessionButton.addEventListener( "click", (e) =>
    fetch(getSessionUrl, {
      method: 'post'
    }).then( (response) =>
      response.json()
    ).then( (sessionObject) => {
      sessionKey.innerHTML = sessionObject.session.value
    })
  )
</script>


<br>
<br>
<div>
  <div>
    <label for='room_name'>Room name</label>
    <input id='room_name' placeholder='room name'>
  </div>
  <div>
    <label for='room_point_limit'>Room point limit</label>
    <input id='room_point_limit' placeholder='5000'>
  </div>
  <button id='create_room'>Create room</button>
</div>

<div>
  <div>Room creation status: <span id='room_create_status'></span></div>
  <div>Room creation errors: <span id='room_create_errors'></span></div>
</div>
<script>
  var createRoomButton = document.querySelector("#create_room");
  var roomCreateStatus = document.querySelector('#room_create_status')
  var roomCreateErrors = document.querySelector('#room_create_errors')
  var roomName         = document.querySelector('#room_name')
  var roomPointLimit   = document.querySelector('#room_point_limit')

  var createRoomUrl    = "http://localhost:3000/rooms";

  createRoomButton.addEventListener( "click", (e) => {
    var body = JSON.stringify({
      session_token: sessionKey.textContent,
      room: {
        name: roomName.value,
        point_limit: roomPointLimit.value
      }
    })


    fetch(createRoomUrl, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: body,
    }).then( (response) => {
      roomCreateStatus.innerHTML = response.status
      if(response.status == 422) {
        // console.log(response.json())
        return response
      } else {
        return response
      }
    }).then( (response) => {
      return response.json()
    }).then( (returnValue) => {
      if(returnValue.errors) {
        string = "<ul>" + returnValue.errors.map( (err) => "<li>" + err + "</li>" ).join("") + "</ul>";
        roomCreateErrors.innerHTML = string;
      } else {
        roomCreateErrors.innerHTML = '';
        console.log(returnValue);
      }
    })

  })
</script>

<br>
<br>
<br>

<button id='get_all_rooms'>Start polling rooms</button>
<div>
  Last rooms request at: <span id='last_rooms_request_at'></span>
</div>
<div>Rooms</div>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Point limit</th>
      <th>Users</th>
    </tr>
  </thead>
  <tbody id='rooms_table'>
  </tbody>
</table>

<script>
  var getAllRooms        = document.querySelector("#get_all_rooms")
  var roomsTable         = document.querySelector("#rooms_table")
  var lastRoomsRequestAt = document.querySelector("#last_rooms_request_at")

  function fetchRooms(){
    var getRoomsUrl = "http://localhost:3000/rooms?session_token=" + sessionKey.textContent;
    fetch(getRoomsUrl).then( (response) =>
      response.json()
    ).then( (returnValue) => {
      string = returnValue.rooms.map( (room) =>
        "<tr><td>" + room.name + "</td><td>" + room.point_limit + "</td><td>" + room.sessions_count + "</td></tr>"
      ).join("");
      roomsTable.innerHTML = string;
      lastRoomsRequestAt.innerHTML = new Date();
    })

    setTimeout(fetchRooms, 1000)
  }

  getAllRooms.addEventListener('click', () => {
    fetchRooms()
  })

</script>


<!--   getSessionButton.addEventListener( "click", (e) =>
    fetch(getSessionUrl, {
      method: 'post'
    }).then( (response) =>
      response.json()
    ).then( (sessionObject) => {
      sessionKey.innerHTML = sessionObject.session.value
    })
  )
 -->
